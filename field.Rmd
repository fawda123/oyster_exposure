---
title: "Puget Sound field data"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, warning=FALSE, message=FALSE, echo = T}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sjPlot)
library(multcompView)
library(here)

# import oyster data
dat <- read.csv(here::here('data/raw', 'field_data.csv'), stringsAsFactors = F) %>% 
  select(Exposure, Organism, Full_ID, Station, Group, Individual, Length_mm, Final_Weight) %>% 
  mutate(
    Station = factor(Station, levels = c('OUT', 'EDG', 'MID')), 
    Exposure = factor(Exposure, levels = c('Pre', 'Post'))
  ) %>% 
  rename(
    Weight = Final_Weight
  ) %>% 
  filter(!Organism %in% 'Mussels') %>% 
  gather('var', 'val', Length_mm, Weight)

# proc
datprc <- dat %>%
  group_by(Organism, var) %>% 
  nest() %>% 
  mutate(
    lmmod = map(data, ~aov(val ~ Exposure * Station, data = .x)),
    phmod = map(lmmod, TukeyHSD),
    ltmod = map(phmod, function(x){
      modhsd <- x %>% 
        .$`Exposure:Station` %>% 
        data.frame
      pvals <- modhsd$p.adj
      names(pvals) <- rownames(modhsd)
      lets <- multcompLetters(pvals)
      
      return(lets)
      
    }),
    plors = pmap(list(Organism, var, lmmod), function(Organism, var, lmmod){
      
      plot_model(lmmod, type = 'int', mdrt.values = 'meansd') + ggtitle(paste(Organism, var, sep = ', '))
      
    })
  )

```


```{r fig.height = 4, fig.width = 4}
plofun <- function(x){
  
  psig=as.numeric(apply(x$`Exposure:Station`[,2:3],1,prod)>=0)+1
  op=par(mar=c(4.2,9,3.8,2))
  plot(x,col=psig,yaxt="n")
  for (j in 1:length(psig)){
  axis(2,at=j,labels=rownames(x$`Exposure:Station`)[length(psig)-j+1],
       las=1,cex.axis=.8,col.axis=psig[length(psig)-j+1])
  }
  par(op)
}

datprc$plors[[1]]
datprc$ltmod[[1]]
plofun(datprc$phmod[[1]])

datprc$plors[[2]]
datprc$ltmod[[2]]
plofun(datprc$phmod[[2]])

datprc$plors[[3]]
datprc$ltmod[[3]]
plofun(datprc$phmod[[3]])

datprc$plors[[4]]
datprc$ltmod[[4]]
plofun(datprc$phmod[[4]])
```

Alternative plots, these show the post-hoc comparisons of the locations from an ANOVA of treatment x location, see the above plots for all comparisons:

```{r, fig.height = 4, fig.width = 5, out.width = '60%', message = F}
# Olympia
toplo <- datprc %>% 
  mutate(
    phmod = purrr::map(phmod, function(x){
      x$`Exposure:Station` %>% 
        data.frame %>% 
        mutate(
          comp = row.names(.)
        )
    })
  ) %>% 
  select(Organism, var, phmod) %>% 
  unnest('phmod') %>% 
  filter(comp %in% c('Post:OUT-Pre:OUT', 'Post:MID-Pre:MID', 'Post:EDG-Pre:EDG')) %>% 
  mutate(
    comp = factor(comp, 
      levels = c('Post:OUT-Pre:OUT', 'Post:EDG-Pre:EDG', 'Post:MID-Pre:MID'), 
      labels = c('Out', 'Edge', 'Mid')
    ), 
    pcol = ifelse(p.adj <= 0.05, 'p < 0.05', 'ns'), 
    var = factor(var, levels = c('Length_mm', 'Weight'), labels = c('Delta~Length (mm)', 'Delta~Weight (g)')), 
    Organism = factor(Organism, levels = c('Olympia', 'Pacific'))
  ) 

p <- ggplot(toplo, aes(y = comp, x = diff, linetype = pcol, col = Organism)) + 
  geom_vline(xintercept = 0, color = 'black', linetype = 'dotted') +
  geom_point(position = position_dodge(width = 0.3), size = 3) + 
  geom_errorbar(aes(xmin = lwr, xmax = upr), position = position_dodge(width = 0.3), width = 0.2) + 
  facet_wrap(~var, scales = 'free_x', ncol = 2, strip.position = 'bottom', labeller = label_parsed) + 
  scale_linetype_manual(values = c('dashed', 'solid')) +
  theme_bw() + 
  theme(
    strip.placement = 'outside', 
    panel.grid.minor = element_blank(), 
    strip.background = element_blank(), 
    axis.title = element_blank(), 
    legend.title = element_blank(), 
    legend.position = 'top', 
    strip.text = element_text(size = 12)
    )

# pout
jpeg(here('figs/fieldcomp.jpeg'), height = 4, width = 5, family = 'serif', units = 'in', res = 500)
print(p)
dev.off()

knitr::include_graphics(here('figs/fieldcomp.jpeg'))
```

