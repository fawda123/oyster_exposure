---
title: "Puget Sound observed pH time series decomposition"
author: "M. W. Beck"
output: html_document
---
  
```{r setup, warning = F, message = F}
library(knitr)
library(tidyverse)
library(readxl)
library(here)
library(lubridate)
library(oce)
library(mgcv)

opts_chunk$set(warning = FALSE, message = FALSE)
```

# {.tabset}

## WDNR buoy edge, center

Import, format data and run decomposition. 

```{r}
obsdat <- read.csv(here('data/raw/2018 WDNR pH sensor data - 2018 WDNR pH sensor data.csv.csv')) %>% 
  select(Date, TimePST, matches('pH')) %>% 
  gather('loc', 'pH', -Date, -TimePST) %>% 
  mutate(
    loc = case_when(
      grepl('Buoy', loc) ~ 'Buoy', 
      grepl('Edge', loc) ~ 'Farm edge', 
      grepl('Mid', loc) ~ 'Farm center'
    ), 
    loc = factor(loc, levels = c('Buoy', 'Farm edge', 'Farm center'))
  ) %>% 
  unite('datetime', Date, TimePST, sep = ' ') %>% 
  mutate(
    datetime = mdy_hms(datetime, tz = 'Pacific/Pitcairn')
  ) %>% 
  filter(as.Date(datetime) <= ymd('2018-07-07') & as.Date(datetime) >= ymd('2018-05-25'))

# decomp
phres <- obsdat %>% 
  group_by(loc) %>% 
  nest() %>% 
  mutate(
    annprd = pmap(list(loc, data), function(loc, data){
      
      dat <- data %>% 
        filter(minute(datetime) == 0) %>% 
        mutate(dectime = decimal_date(datetime))
      
      # annmod <- lm(pH ~ sin(2*pi*dectime) + cos(2*pi*dectime), data = dat, na.action = na.exclude)
      
      out <- dat %>% 
        mutate(
          ph_ann = stats::filter(pH, filter = rep(1, 24) / 24, sides = 1, method = 'convolution'),#predict(annmod),
          ph_anndtrn = pH - ph_ann
        )
      
      return(out)
      
    }),
    sumval = map(annprd, function(annprd){
      
      out <- tibble(
        avev = mean(annprd$pH, na.rm = T),
        minv = min(annprd$pH, na.rm = T),
        maxv = max(annprd$pH, na.rm = T),
        sdv = sd(annprd$pH, na.rm = T)
      )
      
      return(out)
      
    }), 
    dlyprd = map(annprd, function(annprd){
      
      datsub <- annprd %>% 
        mutate(
          decdays =  365 * (decimal_date(datetime) - max(year(datetime))), 
          hrs = hour(datetime)
        )

      dlymod <- lm(ph_anndtrn ~ sin(2*pi*decdays) + cos(2*pi*decdays), data = datsub, na.action = na.exclude)
      # dlymod <- gam(ph_anndtrn ~ s(hrs, bs = 'cc'), data = datsub, na.action = na.exclude)
      
      dlyprd <- datsub %>% 
        mutate(
          ph_dly = predict(dlymod),
          ph_dlydtrn = ph_anndtrn - ph_dly
        )
      
      datsl <- as.sealevel(elevation = dlyprd$ph_dlydtrn, time = dlyprd$datetime)
      
      constituents <- c('M2', 'S2', 'N2', 'K1', 'O1')
      
      # loop through tidal components, predict each with tidem
      preds <- sapply(constituents, function(x){
        
        mod <- tidem(t = datsl, constituent = x)
        pred <- predict(mod)
        pred - mean(pred, na.rm = T)
        
      })
      
      out <- dlyprd %>% 
        mutate(
          K1 = data.frame(preds)[['K1']],
          O1 = data.frame(preds)[['O1']],
          S2 = data.frame(preds)[['S2']],
          N2 = data.frame(preds)[['N2']],
          M2 = data.frame(preds)[['M2']]
        ) %>% 
        rowwise() %>% 
        mutate(
          ph_mod = sum(ph_ann, ph_dly, K1, O1, S2, N2, M2)
        ) %>% 
        ungroup()
      
      return(out)
      
    }),
    rngs = pmap(list(dlyprd, annprd), function(dlyprd, annprd){
      
      rngs <- dlyprd %>% 
        select(ph_dly, K1, O1, S2, N2, M2) %>% 
        mutate(
          ph_dly = ph_dly - mean(ph_dly, na.rm = T)
        ) %>% 
        gather('var', 'val') %>% 
        group_by(var) %>% 
        summarise(
          minv = min(val, na.rm = T), 
          maxv = max(val, na.rm = T),
          .groups = 'drop'
        )
      
      ann <- range(annprd$ph_ann, na.rm = T) %>% 
        diff %>% 
        `/`(2) %>% 
        tibble(
          var = 'ann', 
          minv = ., 
          maxv = .
        ) %>% 
        mutate(
          minv = -1 * minv
        )
      
      out <- bind_rows(rngs, ann) %>% 
        mutate(
          var = factor(var, 
                       levels = c('ann', 'ph_dly', 'K1', 'O1', 'M2', 'S2', 'N2'), 
                       labels = c('Annual', 'Daily', 'K1', 'O1', 'M2', 'S2', 'N2')
          )
        )
      
      return(out)
      
    }),
    dlyrng = map(dlyprd, function(dlyprd){
      
      out <- dlyprd %>% 
        mutate(
          dy = yday(datetime)
        ) %>% 
        group_by(dy) %>% 
        summarise(
          minph = ifelse(length(na.omit(ph_mod)) > 0, min(ph_mod, na.rm = T), NA),
          maxph = ifelse(length(na.omit(ph_mod)) > 0, max(ph_mod, na.rm = T), NA),
          .groups = 'drop'
        ) %>% 
        mutate(
          phdff = (maxph - minph) / 2
        )
      
      return(out)
      
    })
  )
```

pH time series for all locations plus estimated annual component. 

```{r, fig.height = 6, fig.width = 9}
annplo <- phres %>% 
  select(annprd) %>% 
  unnest('annprd') 

p <- ggplot(annplo, aes(x = datetime, y = pH)) + 
  geom_line() + 
  geom_line(aes(y = ph_ann, col = 'Annual')) +
  scale_color_manual(values = 'red') + 
  facet_wrap(~loc, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```

pH time series for all locations 24 hour smooth detrended. 

```{r, fig.height = 6, fig.width = 9}
p <- ggplot(annplo, aes(x = datetime, y = ph_anndtrn)) + 
  geom_line() + 
  facet_wrap(~loc, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```

pH time series for all locations 24 hour smooth detrended, daily sine wave. 

```{r, fig.height = 6, fig.width = 9}
dlyplo <- phres %>% 
  select(dlyprd) %>% 
  unnest('dlyprd') 

p <- ggplot(dlyplo, aes(x = datetime, y = ph_anndtrn)) + 
  geom_line() + 
  geom_line(aes(y = ph_dly, col = 'Daily')) +
  scale_color_manual(values = 'red') + 
  facet_wrap(~loc, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```

pH time series for all locations, observed and modelled. 

```{r, fig.height = 6, fig.width = 9}
dlyplo <- phres %>% 
  select(dlyprd) %>% 
  unnest('dlyprd') 

p <- ggplot(dlyplo, aes(x = datetime, y = pH)) + 
  geom_line() + 
  geom_line(aes(y = ph_mod, col = 'Modelled')) +
  scale_color_manual(values = 'red') + 
  facet_wrap(~loc, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```


Estimated amplitudes for annual, daily, and tidal components for each location. 

```{r, fig.height = 8, fig.width = 5}

rngplo <- phres %>% 
  select(rngs) %>% 
  unnest('rngs')

ggplot(rngplo, aes(x = var)) + 
  geom_errorbar(aes(ymin = minv, ymax = maxv)) + 
  geom_hline(yintercept = 0, linetype = 'dotted') + 
  facet_wrap(~loc, ncol = 1) +
  theme_minimal() + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) +
  labs(
    y = 'pH range', 
    x = NULL
  )
```

Estimated amplitudes for annual, daily, and tidal components for each location, alternative plot. 

```{r, fig.height = 4, fig.width = 10}

rngplo <- phres %>% 
  select(rngs) %>% 
  unnest('rngs')

ggplot(rngplo, aes(x = loc)) + 
  geom_errorbar(aes(ymin = minv, ymax = maxv)) + 
  geom_hline(yintercept = 0, linetype = 'dotted') + 
  theme_minimal() + 
  facet_wrap(~var, scales = 'free_y', ncol = 7) + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8)
  ) +
  labs(
    y = 'pH range', 
    x = NULL
  )
```

Distribution of total range of pH across days from May to August 2012. 

```{r, fig.height = 7, fig.width = 6}
dlyrngplo <- phres %>% 
  select(dlyrng) %>% 
  unnest('dlyrng')

ggplot(dlyrngplo, aes(x = phdff)) + 
  geom_histogram() + 
  facet_wrap(~loc, ncol = 1) + 
  theme_minimal() + 
  labs(
    x = 'daily pH amplitude, May-Aug', 
    y = 'Density'
  )
```

## PMEL

Import, format data and run decomposition. 

```{r}
subdts <- ymd(c('2018-05-25', '2018-07-06'))

# original data
obsdat1 <- read.csv(here('data/raw/SB1_1m_PMEL_2017-2018.csv')) %>% 
  group_by(year, month, day, hour) %>% 
  sample_n(1) %>% # sometimes there's more than one measurement per hour
  ungroup %>% 
  unite('date', month, day, year, sep = '-') %>% 
  unite('time', hour, min, sec, sep = ':') %>% 
  unite('datetime', date, time, sep = ' ') %>% 
  mutate(
    datetime = mdy_hms(datetime, tz = 'Pacific/Pitcairn'), 
    datetime = floor_date(datetime, unit = 'hour'),
    typ = 'original'
  ) %>% 
  filter(as.Date(datetime) <= subdts[2] & as.Date(datetime) >= subdts[1])

# resampled
obsdat2 <- read.csv(here('data/raw/SB1_1m_PMEL_2018_resampled.csv')) %>% 
  unite('date', month, day, year, sep = '-') %>% 
  unite('time', hour, min, sec, sep = ':') %>% 
  unite('datetime', date, time, sep = ' ') %>% 
  mutate(
    datetime = mdy_hms(datetime, tz = 'Pacific/Pitcairn'), 
    typ = 'resampled'
  ) %>% 
  filter(as.Date(datetime) <= subdts[2] & as.Date(datetime) >= subdts[1]) %>% 
  filter(minute(datetime) == 0) # subset to hour

# combine
obsdat <- bind_rows(obsdat1, obsdat2) %>% 
  rename(pH = pH_tot)

# decomp
phres <- obsdat %>% 
  group_by(typ) %>% 
  nest() %>% 
  mutate(
    annprd = pmap(list(typ, data), function(typ, data){
      
      dat <- data %>% 
        mutate(dectime = decimal_date(datetime))
      
      # annmod <- lm(pH ~ sin(2*pi*dectime) + cos(2*pi*dectime), data = dat, na.action = na.exclude)
      
      out <- dat %>% 
        mutate(
          ph_ann = stats::filter(pH, filter = rep(1, 24) / 24, sides = 1, method = 'convolution'),#predict(annmod),
          ph_anndtrn = pH - ph_ann
        )
      
      return(out)
      
    }),
    sumval = map(annprd, function(annprd){
      
      out <- tibble(
        avev = mean(annprd$pH, na.rm = T),
        minv = min(annprd$pH, na.rm = T),
        maxv = max(annprd$pH, na.rm = T),
        sdv = sd(annprd$pH, na.rm = T)
      )
      
      return(out)
      
    }), 
    dlyprd = map(annprd, function(annprd){
      
      datsub <- annprd %>% 
        mutate(
          decdays =  365 * (decimal_date(datetime) - max(year(datetime))), 
          hrs = hour(datetime)
        )

      dlymod <- lm(ph_anndtrn ~ sin(2*pi*decdays) + cos(2*pi*decdays), data = datsub, na.action = na.exclude)
      # dlymod <- gam(ph_anndtrn ~ s(hrs, bs = 'cc'), data = datsub, na.action = na.exclude)
      
      dlyprd <- datsub %>% 
        mutate(
          ph_dly = predict(dlymod),
          ph_dlydtrn = ph_anndtrn - ph_dly
        )
      
      datsl <- as.sealevel(elevation = dlyprd$ph_dlydtrn, time = dlyprd$datetime)
      
      constituents <- c('M2', 'S2', 'N2', 'K1', 'O1')
      
      # loop through tidal components, predict each with tidem
      preds <- sapply(constituents, function(x){
        
        mod <- tidem(t = datsl, constituent = x)
        pred <- predict(mod)
        pred - mean(pred, na.rm = T)
        
      })
      
      out <- dlyprd %>% 
        mutate(
          K1 = data.frame(preds)[['K1']],
          O1 = data.frame(preds)[['O1']],
          S2 = data.frame(preds)[['S2']],
          N2 = data.frame(preds)[['N2']],
          M2 = data.frame(preds)[['M2']]
        ) %>% 
        rowwise() %>% 
        mutate(
          ph_mod = sum(ph_ann, ph_dly, K1, O1, S2, N2, M2)
        ) %>% 
        ungroup()
      
      return(out)
      
    }),
    rngs = pmap(list(dlyprd, annprd), function(dlyprd, annprd){
      
      rngs <- dlyprd %>% 
        select(ph_dly, K1, O1, S2, N2, M2) %>% 
        mutate(
          ph_dly = ph_dly - mean(ph_dly, na.rm = T)
        ) %>% 
        gather('var', 'val') %>% 
        group_by(var) %>% 
        summarise(
          minv = min(val, na.rm = T), 
          maxv = max(val, na.rm = T),
          .groups = 'drop'
        )
      
      ann <- range(annprd$ph_ann, na.rm = T) %>% 
        diff %>% 
        `/`(2) %>% 
        tibble(
          var = 'ann', 
          minv = ., 
          maxv = .
        ) %>% 
        mutate(
          minv = -1 * minv
        )
      
      out <- bind_rows(rngs, ann) %>% 
        mutate(
          var = factor(var, 
                       levels = c('ann', 'ph_dly', 'K1', 'O1', 'M2', 'S2', 'N2'), 
                       labels = c('Annual', 'Daily', 'K1', 'O1', 'M2', 'S2', 'N2')
          )
        )
      
      return(out)
      
    }),
    dlyrng = map(dlyprd, function(dlyprd){
      
      out <- dlyprd %>% 
        mutate(
          dy = yday(datetime)
        ) %>% 
        group_by(dy) %>% 
        summarise(
          minph = ifelse(length(na.omit(ph_mod)) > 0, min(ph_mod, na.rm = T), NA),
          maxph = ifelse(length(na.omit(ph_mod)) > 0, max(ph_mod, na.rm = T), NA),
          .groups = 'drop'
        ) %>% 
        mutate(
          phdff = (maxph - minph) / 2
        )
      
      return(out)
      
    })
  )
```

pH time series for the two datasets plus estimated annual component. 

```{r, fig.height = 4, fig.width = 9}
annplo <- phres %>% 
  select(annprd) %>% 
  unnest('annprd') 

p <- ggplot(annplo, aes(x = datetime, y = pH)) + 
  geom_line() + 
  geom_line(aes(y = ph_ann, col = 'Annual')) +
  scale_color_manual(values = 'red') + 
  facet_wrap(~typ, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```

pH time series for the two datasets 24 hour smooth detrended. 

```{r, fig.height = 4, fig.width = 9}
p <- ggplot(annplo, aes(x = datetime, y = ph_anndtrn)) + 
  geom_line() + 
  facet_wrap(~typ, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```

pH time series for the two datasets 24 hour smooth detrended, daily sine wave. 

```{r, fig.height = 4, fig.width = 9}
dlyplo <- phres %>% 
  select(dlyprd) %>% 
  unnest('dlyprd') 

p <- ggplot(dlyplo, aes(x = datetime, y = ph_anndtrn)) + 
  geom_line() + 
  geom_line(aes(y = ph_dly, col = 'Daily')) +
  scale_color_manual(values = 'red') + 
  facet_wrap(~typ, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```

pH time series for the two datasets, observed and modelled. 

```{r, fig.height = 4, fig.width = 9}
dlyplo <- phres %>% 
  select(dlyprd) %>% 
  unnest('dlyprd') 

p <- ggplot(dlyplo, aes(x = datetime, y = pH)) + 
  geom_line() + 
  geom_line(aes(y = ph_mod, col = 'Modelled')) +
  scale_color_manual(values = 'red') + 
  facet_wrap(~typ, ncol = 1) + 
  theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank()
  ) +
  labs(
    x = NULL
  )
p
```


Estimated amplitudes for annual, daily, and tidal components for the two datasets. 

```{r, fig.height = 5.5, fig.width = 5}

rngplo <- phres %>% 
  select(rngs) %>% 
  unnest('rngs')

ggplot(rngplo, aes(x = var)) + 
  geom_errorbar(aes(ymin = minv, ymax = maxv)) + 
  geom_hline(yintercept = 0, linetype = 'dotted') + 
  facet_wrap(~typ, ncol = 1) +
  theme_minimal() + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    panel.grid.minor.x = element_blank()
  ) +
  labs(
    y = 'pH range', 
    x = NULL
  )
```

Estimated amplitudes for annual, daily, and tidal components for the two datasets, alternative plot. 

```{r, fig.height = 4, fig.width = 10}

rngplo <- phres %>% 
  select(rngs) %>% 
  unnest('rngs')

ggplot(rngplo, aes(x = typ)) + 
  geom_errorbar(aes(ymin = minv, ymax = maxv)) + 
  geom_hline(yintercept = 0, linetype = 'dotted') + 
  theme_minimal() + 
  facet_wrap(~var, scales = 'free_y', ncol = 7) + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8)
  ) +
  labs(
    y = 'pH range', 
    x = NULL
  )
```

Distribution of total range of pH across days from May to August 2012. 

```{r, fig.height = 5, fig.width = 6}
dlyrngplo <- phres %>% 
  select(dlyrng) %>% 
  unnest('dlyrng')

ggplot(dlyrngplo, aes(x = phdff)) + 
  geom_histogram() + 
  facet_wrap(~typ, ncol = 1) + 
  theme_minimal() + 
  labs(
    x = 'daily pH amplitude, May-Aug', 
    y = 'Density'
  )
```